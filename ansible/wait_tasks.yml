---
- name: Wait for vsphere-cloud-controller-manager DaemonSet to be fully rolled out
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: DaemonSet
    name: vsphere-cloud-controller-manager
    namespace: kube-system
    kubeconfig: "{{kube_config_file_no_loadbalancer}}"
  register: cpi_ds
  until: >
    cpi_ds.resources | length > 0 and
    cpi_ds.resources[0].status is defined and
    cpi_ds.resources[0].status.desiredNumberScheduled is defined and
    cpi_ds.resources[0].status.numberReady is defined and
    cpi_ds.resources[0].status.updatedNumberScheduled is defined and
    cpi_ds.resources[0].status.numberReady == cpi_ds.resources[0].status.desiredNumberScheduled and
    cpi_ds.resources[0].status.updatedNumberScheduled == cpi_ds.resources[0].status.desiredNumberScheduled
  retries: 60
  delay: 10
  delegate_to: localhost

- name: Restart kubelet service on VIP node
  ansible.builtin.shell:
    cmd: "talosctl service kubelet restart -n {{ talos_interface_vip }} \
      --talosconfig {{talos_config_folder}}{{ target }}.yaml "
  delegate_to: localhost
  run_once: true
  async: 120
  poll: 0

- name: Wait one more minute
  ansible.builtin.pause:
    minutes: 1

- name: Wait for all nodes to have cloud provider initialized (no uninitialized taint)
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    kubeconfig: "{{kube_config_file_no_loadbalancer}}"
  register: nodes
  until: >
    nodes.resources is defined and
    nodes.resources | length > 0 and
    (nodes.resources | json_query('[?spec.taints[?key == `node.cloudprovider.kubernetes.io/uninitialized`]]') | length) == 0
  retries: 120
  delay: 5
  delegate_to: localhost
