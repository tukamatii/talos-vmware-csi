- name: Add vsphere-tmm Helm repository
  kubernetes.core.helm_repository:
    name: vsphere-tmm
    repo_url: "{{ vsphere_csi_helm_repo_url }}"
  delegate_to: localhost

- name: Build vCenter configuration dict with dynamic key
  set_fact:
    vcenter_dict: "{{ {} | combine({(vcenter_hostname | trim): {
      'server': vcenter_hostname | trim,
      'user': vcenter_cpi_user | trim,
      'password': vcenter_cpi_password | trim,
      'datacenters': vcenter_datacenters
      }}) }}"

- name: Debug vCenter dict and full Helm values
  debug:
    msg:
      - "vCenter config dict:"
      - "{{ vcenter_dict | to_nice_yaml }}"
      - "Full Helm release_values:"
      - "{{ helm_release_values | to_nice_yaml }}"
  vars:
    helm_release_values:
      global:
        config:
          global:
            cluster-id: "{{ target | trim }}"
          storageclass:
            enabled: "{{ vsphere_csi_storageclass_enabled }}"
            storagepolicyname: "{{ vsphere_csi_storage_policy_name }}"
            default: "{{ vsphere_csi_storageclass_default }}"
            reclaimPolicy: "{{ vsphere_csi_reclaim_policy }}"
            volumebindingmode: "{{ vsphere_csi_volume_binding_mode }}"
            datastoreurl: "{{ vsphere_csi_datastore_url }}"
          vcenter: "{{ vcenter_dict }}"
  delegate_to: localhost

- name: Ensure vmware-csi namespace exists with privileged PodSecurity policy
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: "{{ vsphere_csi_namespace }}"
    state: present
    definition:
      metadata:
        name: vmware-csi
        labels:
          pod-security.kubernetes.io/enforce: privileged
          pod-security.kubernetes.io/audit: privileged
          pod-security.kubernetes.io/warn: privileged
    kubeconfig: "{{ kube_config_file_no_loadbalancer }}"
  delegate_to: localhost

- name: Deploy vsphere-tmm from Helm chart
  kubernetes.core.helm:
    name: "{{ vsphere_csi_release_name }}"
    chart_ref: "{{ vsphere_csi_chart_ref }}"
    chart_version: "{{ vsphere_csi_chart_version }}"
    namespace: "{{ vsphere_csi_namespace }}"
    create_namespace: true
    kubeconfig: "{{ kube_config_file_no_loadbalancer }}"
    release_values:
      global:
        config:
          global:
            cluster-id: "{{ target | trim }}"
          storageclass:
            enabled: "{{ vsphere_csi_storageclass_enabled }}"
            storagepolicyname: "{{ vsphere_csi_storage_policy_name }}"
            default: "{{ vsphere_csi_storageclass_default }}"
            reclaimPolicy: "{{ vsphere_csi_reclaim_policy }}"
            volumebindingmode: "{{ vsphere_csi_volume_binding_mode }}"
            datastoreurl: "{{ vsphere_csi_datastore_url }}"
          vcenter: "{{ vcenter_dict }}"
    state: present
    wait: true
    wait_timeout: "600s"
  ignore_errors: true
  delegate_to: localhost

- name: Patch vsphere-csi StorageClass to set reclaimPolicy=Retain
  kubernetes.core.k8s:
    api_version: storage.k8s.io/v1
    kind: StorageClass
    name: vsphere-csi
    state: patched
    definition:
      reclaimPolicy: Retain
    kubeconfig: "{{ kube_config_file_no_loadbalancer }}"
  delegate_to: localhost

